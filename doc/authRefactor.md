# Auth Refactor (Public Browse + Auth-Gated Booking)

This document captures the changes made in this session to support public hotel browsing, gate booking behind authentication, and preserve admin-only access.

## Summary

- **Customer browsing is now public** for `/select-location` and `/hotels/$hotelId`.
- **Booking is auth-gated**: users are prompted to sign in before they can book.
- **Admins still require login** and remain role-protected.
- **Redirect flow added** to return users to the hotel they tried to book after auth.        //this wasn't done right 

- **Duplicate header fixed** by hiding the global header on customer pages that provide their own.
- **Landing page CTA updated** to include a "Browse Hotels" button.

## Route Structure Changes

Moved customer browsing routes out of the authenticated layout:

- `src/routes/_authenticated/select-location.tsx` -> `src/routes/select-location.tsx`
- `src/routes/_authenticated/hotels.$hotelId.tsx` -> `src/routes/hotels.$hotelId.tsx`
- `/bookings` remains under `src/routes/_authenticated/bookings.tsx`

**Why:** The customer browsing experience should be public, while booking and "My Bookings" stay protected.

References:
- [src/routes/select-location.tsx](../src/routes/select-location.tsx)
- [src/routes/hotels.$hotelId.tsx](../src/routes/hotels.$hotelId.tsx)
- [src/routes/_authenticated/bookings.tsx](../src/routes/_authenticated/bookings.tsx)
- [src/routes/_authenticated.tsx](../src/routes/_authenticated.tsx)

## Booking Gated by Auth

On the hotel detail page:

- If dates are selected and the user is **not signed in**, clicking "Book Now" redirects to `/sign-in` with a `redirect` param.
- If signed in, the booking modal opens normally.

Reference:
- [src/routes/hotels.$hotelId.tsx](../src/routes/hotels.$hotelId.tsx)

## Redirect After Auth (Return to Hotel)

We added a redirect pipeline so customers return to the exact hotel page they attempted to book.

Flow:

1. Hotel page sends user to `/sign-in?redirect=/hotels/<id>`
2. Sign-in and sign-up pages forward the redirect param to `/post-login`
3. `/post-login` routes:
   - Admin -> `/admin`
   - Customer -> `redirect` (if provided) or `/select-location`

References:
- [src/routes/hotels.$hotelId.tsx](../src/routes/hotels.$hotelId.tsx)
- [src/routes/sign-in.tsx](../src/routes/sign-in.tsx)
- [src/routes/sign-in.$.tsx](../src/routes/sign-in.$.tsx)
- [src/routes/sign-up.tsx](../src/routes/sign-up.tsx)
- [src/routes/sign-up.$.tsx](../src/routes/sign-up.$.tsx)
- [src/routes/post-login.tsx](../src/routes/post-login.tsx)

## Landing Page CTA

We added a "Browse Hotels" CTA while keeping the landing page intact for sign-in and sign-up.

Reference:
- [src/routes/index.tsx](../src/routes/index.tsx)

## Header Behavior (Fix for Double Headers)

Customer browse pages already render their own headers. The global header is now hidden on:

- `/select-location`
- `/hotels/*`
- `/bookings`

It also remains hidden on auth pages and admin routes.

Reference:
- [src/components/Header.tsx](../src/components/Header.tsx)

## Route Tree Update

The route tree was updated to reflect the new route locations:

- `/select-location` and `/hotels/$hotelId` are now **root routes**
- `/bookings` remains under `_authenticated`

Reference:
- [src/routeTree.gen.ts](../src/routeTree.gen.ts)

Note: This file is auto-generated by TanStack Router and may be regenerated.

## SSR Error Observed During UI Work

An SSR error was observed:

- `isSignedIn is not defined` in `SelectLocationPage`

Cause:
- `isSignedIn` referenced in JSX but not defined in the component scope.

Fix:
- Ensure `useUser()` (or `useAuth()`) defines `isSignedIn` inside `SelectLocationPage`.

Reference:
- [src/routes/select-location.tsx](../src/routes/select-location.tsx)

## Files Touched (Summary)

- `src/routes/select-location.tsx`
- `src/routes/hotels.$hotelId.tsx`
- `src/routes/_authenticated/bookings.tsx` (unchanged but still protected)
- `src/routes/_authenticated.tsx` (unchanged)
- `src/routes/sign-in.tsx`
- `src/routes/sign-in.$.tsx`
- `src/routes/sign-up.tsx`
- `src/routes/sign-up.$.tsx`
- `src/routes/post-login.tsx`
- `src/routes/index.tsx`
- `src/components/Header.tsx`
- `src/routeTree.gen.ts`

## Validation Checklist

- Public users can browse `/select-location` and `/hotels/$hotelId` without auth.
- Clicking "Book Now" when signed out redirects to `/sign-in`.
- After sign-in, customers return to the hotel they attempted to book.
- `/bookings` still requires authentication.
- `/admin` remains protected and role-based.
